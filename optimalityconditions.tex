%!TEX root = kdv.tex
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{First order optimality conditions}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\label{secoptconditions}
Next we discuss the differentiability of the control-to-state operator $S$ defined in \eqref{controltostate}.
\begin{proposition}
  The control to state operator $S$ is continuously Fr\'echet-differentiable. Its derivative
  \[
  S'(u)\colon \M\rightarrow \mathcal B,~\delta u\mapsto
  \delta y
  \]
  at $u\in U_{ad}$ is given by the solution operator of the linear tangent equation
  \begin{subequations}
   \begin{numcases}{}
      \partial_t \delta y +\partial_x \delta y -\gamma \partial_{xx} \delta y+ \partial_{xxx} \delta y + \partial_x (y \delta y)=\delta u \mbox{ in } I\times\Omega,  \label{linearizedkdv1}\\
      \delta y(\cdot,0) = \delta y(\cdot,L) = \partial_x \delta y (\cdot,L) = 0 \mbox{ on } I,  \label{linearizedkdv2}\\
      \delta y(0,\cdot) = 0 \mbox{ on } \Omega  \label{linearizedkdv3}.
   \end{numcases}
   \label{tan eq}
  \end{subequations}
  \label{propfrechet}
\end{proposition}
\begin{proof}[Proof of Proposition~\ref{propfrechet}]
First we mention that the non-linearity $F:\mathcal B\rightarrow L^2(I,H^{-1}(\Omega)),~y\mapsto y\partial_x y$ is Fr\'echet differentiable since there holds 
\[
\|F(y+\delta y)-F(y)-F'(y)\delta y\|_{\Hm1}\leq \frac 1 2\|\delta y\|_{L^4(I\times \Omega)}^2\leq c\,\|\delta y\|_{\mathcal B}^2
\]
with $F'(y)\delta y=\partial_x(y\delta y)$ for any $\delta y\in \mathcal B\hookrightarrow L^4(I\times \Omega)$. Then we differentiate the fixed point equation $y=\mathcal L(u-y\partial_x y,y_0)$ with respect to $(y,u)$ in direction $(\delta y,\delta u)\in \mathcal B\times \M$ and get
\be\label{abstract_tangent_equation}
\delta y=\mathcal L'(\delta u-\partial_x(y\delta y))
\ee
where $\mathcal L'(\cdot)=\mathcal L(\cdot,0)$. In the Appendix~\ref{appendixtangent} it is shown that \eqref{abstract_tangent_equation} has a unique solution $\delta y\in \mathcal B$.  Actually $\delta y$ is the weak solution of \eqref{linearizedkdv1}-\eqref{linearizedkdv3} in the sense of \eqref{weakformkdv}. Next we show that $S'(u)\delta u:=\delta y$ is the Fr\'echet derivative of $S$. This will result from the study of
\[
\frac{1}{\norm{\delta u}_{\M}} \norm{S(u + \delta u) - S(u)  -S'(u)\delta u}_{\mathcal B} = \frac{1}{\norm{\delta u}_{\M}} \norm{\tilde{y} - y  -\delta y}_{\mathcal B}.
\]
Calling $w = \tilde{y} - y - \delta y\in \mathcal B$ the function $w$ then satisfies
\bean
  &\partial_t w +\partial_x w + \partial_{xxx} w - \gamma \partial_{xx} w  + \tilde{y}\partial_x \tilde{y}  - y\partial_x y - \partial_x(y\delta y)=  0 \mbox{ in } I\times\Omega,\nonumber\\
  &w(.,0) = w(.,L) = \partial_x w (.,L) = 0 \mbox{ in } I,\nonumber\\
  &w(0,\cdot) = 0 \mbox{ in } \Omega\nonumber.
\eean
in the weak sense of \eqref{weakformkdv}. After rearranging the terms we end up with
\besn
\partial_t w +\partial_x w + \partial_{xxx} w - \gamma \partial_{xx} w  + \partial_x(yw) =  -(\tilde{y} - y)\partial_x(\tilde{y} - y) \mbox{ in } I\times\Omega,\label{kdvw1}\\
w(.,0) = w(.,L) = \partial_x w (.,L) = 0 \mbox{ in } I,\label{kdvw2}\\
w(0,\cdot) = 0\mbox{ in } \Omega\label{kdvw3}.
\eesn
According to Appendix~\ref{appendixtangent} and Lemma \ref{lemyyx2} it holds
\[
\norm{w}_{\mathcal{B}} \leq C(T,L,u)\norm{(\tilde{y} - y)\partial_x(\tilde{y} - y)}_{\Hm1}\leq C(T,L,u)\,T^{1/4}\norm{\tilde{y} - y}_{\mathcal{B}}.
\]
Therefore the conclusion follows from Lipschitz continuity of $S$. Hence we provide the following lemma which concludes the proof.
\qquad\end{proof}

\begin{lemma}
Let $u\in U_{ad}$ and $u+\delta u\in U_{ad}$ for $\delta u\in \M$. The control-to-state operator $S$ satisfies the estimate
\[\|S(u+\delta u)-S(u)\|_{\mathcal B}\leq C(T,L,u)\,\|\delta u\|_{\M}.\]
 \label{lipschitzcontinuity}
\end{lemma}
\begin{proof}[Proof of Lemma~\ref{lipschitzcontinuity}]
We define $y = S(u) \in \mathcal{B}$ and $\tilde{y} = S(u+\delta u) \in \mathcal{B}$. Therefore, the difference $w = \tilde{y} - y$ satisfies the equation
\begin{subequations}
 \begin{numcases}{}
    \partial_t w +\partial_x w + \partial_{xxx} w - \gamma \partial_{xx} w  + (1/2) \partial_x (y w)=  \delta u - (1/2) \partial_x(\tilde yw) \mbox{ in } I\times\Omega,\label{diffkdv4}\\
    w(.,0) = w(.,L) = \partial_x w (.,L) = 0 \mbox{ in } I,\label{diffkdv5}\\
    w(0,x) = 0 \mbox{ in } \Omega\label{diffkdv6},
 \end{numcases}
\end{subequations}
in the weak sense of \eqref{weakformlinearkdv}. According to Appendix \ref{appendixtangent} $w \in \mathcal{B}$ satisfies the a priori estimates
\[
\norm{w}_{\mathcal{B}} \leq C(T,L,u)\norm{\delta u}_{\M}.
\]
Thus we can conclude that the solution operator $S$ is locally Lipschitz continuous.
\qquad\end{proof}

Therefore the control-to-observation operator $S_{obs}$ is also Fr\'echet differentiable and its derivative is given by
\[S_{obs}'(u)\colon \delta u\mapsto (\chi_{\Omega_o}\delta y,\chi_{\Omega_o}\delta y(T))\]
where $\delta y\in \mathcal B$ is the weak solution of \eqref{tan eq}. Next we introduce we adjoint control to observation operator $S'^\star$.
\begin{proposition}
  Let $u\in U_{ad}$. There exists a linear operator
  \[
  S'^\star(u)\colon L^2(I\times\Omega_o)\times L^2(\Omega_o)\rightarrow \C, (\phi,p_T)\mapsto p
  \]
  which fulfills
  \begin{multline}
  (S'(u)\delta u,\phi)_{L^2(I\times \Omega_o)}+((S'(u)\delta u)(T),p_T)_{L^2(\Omega_o)}\\
  =\langle\delta u, S'^\star(u)(\phi,p_T)\rangle_{\M,\C}\\
  \forall \delta u\in\M,~(\phi,p_T) \in L^2(I\times \Omega_o)\times L^2(\Omega_o).
  \label{adjointwf}
  \end{multline}
  Moreover it is the solution operator of
  \begin{subequations}
   \begin{numcases}{}
      -\partial_t p -\partial_x  p -\gamma \partial_{xx} p - \partial_{xxx} p  - y\partial_x p=\phi \mbox{ in } I\times\Omega,\label{adjointKdV1}\\
      p(\cdot,0) = p(\cdot,L) = \partial_x p(\cdot,0) = 0 \mbox{ in } I,\label{adjointKdV2}\\
      p(T,\cdot) = p_T \mbox{ in } \Omega\label{adjointKdV3}
   \end{numcases}
  \end{subequations}
  with $y=S(u)$.
  \label{adjointKdV}
\end{proposition}
\begin{proof}[Proof of Proposition~\ref{adjointKdV}]
First of all we mention that $y\partial_x p\in L^1(I,L^2(\Omega))$ holds for $y\in \mathcal B$ and $p\in \mathcal B$, c.f., Lemma \ref{lemadjoint}. Then we consider the weak formulation of the tangent equation
\be
(\delta y,\phi)_{L^2(I\times\Omega)}+(\delta y(T),p_T)_{L^2(\Omega)}-(\delta y,y\partial_x p)_{L^2(I\times\Omega)}=\langle \delta u,p\rangle_{\M,\mathcal C_I}
\label{tangentwf}
\ee
for $\delta u\in \M$ with $y=S(u)\in\mathcal B$ and therefore  $\delta y=S'(u)\delta u\in\mathcal B$. By identification with \eqref{adjointwf}, we set $S'^\star(u)(\phi,p_T):=p$ where $p$ solves the fixed point equation
\be\label{fixed_point_equation_adjoint}
p(t)=W^*(T-t)p_T+\int_t^TW^*(s-t)(\phi(s)-y(s)\partial_xp(s))~\mathrm ds,~t\in I,
\ee
derived from the form \eqref{adjointmild} with a source term that now also depends on $p$.
The fixed point equation \eqref{fixed_point_equation_adjoint} has a unique solution $p\in \mathcal B\hookrightarrow\C$, for a proof see Appendix \ref{appendixadjoint}.
\qquad\end{proof}

Next we derive first order optimality conditions using tools from convex analysis.
\begin{proposition}
  Let $(\bar y,\bar u)\in \mathcal B\times U_{ad}$ be the solution of \eqref{cost}. Then there
  exists a unique $\bar p\in \C$ which is the solution of the adjoint state equation
  \bean
  &-\partial_t\bar p -\partial_x \bar p -\gamma \partial_{xx} \bar p -\partial_{xxx} \bar p - \bar y\partial_x \bar p=\chi_{\Omega_o}\bar y-z_1 \mbox{ in } \Omega,\\
  &\bar p(\cdot,0) = \bar p(\cdot,L) = \partial_x \bar p(\cdot,0) = 0 \mbox{ in } I,\\
  &\bar p(T,\cdot) =\chi_{\Omega_o}y(T)-z_2 \mbox{ in } \Omega.
  \eean
  and fulfills the following variational inequality condition
  \be
  \langle -\bar p,u-\bar u\rangle_{\C,\M}+\|\bar u\|_{\M}\leq\|u\|_{\M}\quad\forall u\in U_{ad}.
  \label{subgradientcond}
  \ee
\end{proposition}
\begin{proof}
  We define $G(u)=(1/2)\|S_{obs}(u)-z\|_{L^2(I\times \Omega_{obs})}^2$ and $F(u)=\|u\|_{\M}$+$\mathcal I_{U_{ad}}(u)$. Then the directional derivative of $G$ can be expressed using the operator $S_{obs}'^\star(\bar u)$ namely
  \[
  \nabla G(\bar u)=S_{obs}'^\star(\bar u)(S_{obs}(\bar u)-z)\in \C.
  \]
  We define $\bar p := \nabla G(\bar u)$. An element $\bar u\in U_{ad}$ is optimal if
  \[
  G(\bar u)+F(\bar u)\leq G(u)+F(u)\quad\forall u\in U_{ad}
  \]
  and in  particular
  \[
  G(\bar u)+F(\bar u)\leq G(\bar u + \varepsilon(u-\bar u))+F(\bar u+ \varepsilon(u-\bar u))
  \]
  for some $0<\varepsilon$ small enough such that $\bar u + \varepsilon(u-\bar u)\in U_{ad}$ holds. Using the convexity of $F$ we get
  \[
    \frac{G(\bar u)-G(\bar u + \varepsilon(u-\bar u))}{\varepsilon}+ F(\bar u)\leq F(u)
  \]
  which implies
  \[
  \langle-\bar p ,u-\bar u\rangle_{\C,\M} + F(\bar u)\leq F(u)\quad\forall u\in U_{ad}.
  \]
\qquad\end{proof}

\begin{proposition}
The subgradient condition \eqref{subgradientcond} is equivalent to
\begin{equation}\label{equivoc}
\alpha \|\bar u\|_{\M}+\phi^{\star}(-\bar p)=\langle -\bar p,\bar u\rangle_{\C,\M},\quad \bar u\in U_{ad}
\end{equation}
with
\[
\phi^{\star}(p)=\sup_{u\in U_{ad}}[\langle u,p\rangle_{\C,\M}-\alpha \|u\|_{\M}]
\]
for $p\in \C$.
\end{proposition}
See \cite{} for a proof.
\begin{lemma}
The functional $\phi^{\star}(p)\colon \C\rightarrow \mathbb R$ has the form
\[
\phi^{\star}(p)=\hat c\,(\|p\|_{\C}-\alpha))^+
\]
where $\hat c = C/T^{1/4}-\|y_0\|_{L^2(\Omega)}$ and $(\cdot)^+ = \operatorname{max}(0,\cdot)$ is the positive part of a function.
\end{lemma}
\begin{proof}
\begin{align*}
\phi^{\star}(p)&=\sup_{u\in U_{ad}}[\langle u,p\rangle_{\C,\M}-\alpha \|u\|_{\M}]\\
&=\sup_{\|u\|_{\M}=1,\,\lambda\in [0,c]}\lambda[\langle u,p\rangle_{\C,\M}-\alpha].
\end{align*}
This implies the assertion since $\|p\|_{\C}=\sup_{\|u\|_{\M}=1}\langle u,p\rangle_{\C,\M}$.
\qquad\end{proof}

\begin{proposition}
Let $\bar u\in U_{ad}$ be the optimal control of \eqref{cost}. Moreover let $|\bar u|\in \mathcal M(\Omega)$ be its total-variation measure and $\bar u'$ its the Radon-Nikodym-derivative. Furthermore $\bar p\in \C$ be the corresponding optimal adjoint state. Then there holds
\begin{align}
0&=\left(\|\bar u\|_{\M}-\hat c\right)\bar\lambda\label{scalarlagrange}\\
\operatorname{supp}|\bar u|&\subseteq \{x\in \Omega\colon \|\bar p\|_{L^2(I)}=\alpha+\bar\lambda\}\label{controlsupp}.
\end{align}
with $\bar\lambda =(\|\bar p\|_{\C}-\alpha)^+$. Moreover we have
\be
\bar u'(x)=-\frac{\bar p(x)}{\alpha +\bar\lambda}\quad\text{in}~L^1((\Omega,|\bar u|),L^2(I)).
\label{controlintime}
\ee
\label{propsubgcondition}
\end{proposition}
\begin{proof}
Using $\bar u\in U_{ad}$, $\|\bar p\|_{\C}-\bar\lambda\leq\alpha$ and \eqref{equivoc} we can estimate
\begin{multline}\label{estoc}
\alpha\|\bar u\|_{\M}=\int_{\Omega}(\bar u',\bar p)_{L^2(I)}~\mathrm d|\bar u|-\hat c\bar\lambda\leq \int_\Omega(\bar u',\bar p)_{L^2(I)}~\mathrm d|\bar u|-\bar\lambda\|\bar u\|_{\M}\\
\leq \int_\Omega\|\bar u'\|_{L^2(I)}\|\bar p\|_{L^2(I)}~\mathrm d|\bar u|-\bar\lambda\|\bar u\|_{\M}\\
\leq\|\bar u\|_{\M}(\|\bar p\|_{\C}-\bar\lambda)\leq \alpha\|\bar u\|_{\M}.
\end{multline}
Thus the last chain of inequalities holds with equality and therefore we have
\[
\int_{\Omega}(\bar u',\bar p)_{L^2(I)}-\|\bar u'\|_{L^2(I)}\|\bar p\|_{L^2(I)}~\mathrm d|\bar u|=0
\]
which implies $\bar u'=-(1/\|\bar p\|_{L^2(I)})\,\bar p$ in $L^1((\Omega,|\bar u|),L^2(I))$. Moreover we have
\[
\int_\Omega\|\bar p\|_{L^2(I)}-\bar\lambda-\alpha~\mathrm d|\bar u|=0
\]
which then implies \eqref{controlsupp} and \eqref{controlintime}. Equality in \eqref{estoc} also implies
\[
(\hat c-\alpha\|\bar u\|_{\M})\bar\lambda=0.
\]
\qquad\end{proof}

\begin{remark}
If the constraint $\|\bar u\|_{\M}\leq \hat c$ is not active there holds $\bar \lambda=0$ and we recover the usual optimality conditions; c.f. \cite{pieper2014}. This can be guaranteed for a large enough parameter $\alpha$.
\end{remark}


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "kdv.tex"
%%% End:
