%!TEX root = kdv.tex
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{First order optimality conditions}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\label{secoptconditions}
First we discuss the differentiability of the control-to-state operator $S$ defined in \eqref{controltostate}. {\color{red}In order to do that, we introduce the open set
$$\tilde U_{ad} = \begin{cases} \left\{u \in \M\colon \norm{u}_{\M}< c_{ad} \right\} &\quad\mbox{if } \gamma = 0 \\
\M & \quad \mbox{otherwise.}
 \end{cases}$$}
The following Lemma concerning the local Lipschitz continuity of $S$ is needed for the proof of its Fr\'echet differentiability.
\begin{lemma}
The control-to-state operator $S\colon \tilde U_{ad}\rightarrow \mathcal B$ is locally Lipschitz continuous, i.e., for every $u\in \tilde U_{ad}$ there exists a neighbourhood $V\subset \tilde U_{ad}$ and a constant
$C(T,L,u,\tilde u)>0$ such that
\[\|S(u)-S(\tilde u)\|_{\mathcal B}\leq C(T,L,u,\tilde u)\,\|u-\tilde u\|_{\M}\quad \forall \tilde u\in V.\]
 \label{lipschitzcontinuity}
\end{lemma}
%[Proof of Lemma~\ref{lipschitzcontinuity}]
\begin{proof}
We define $y = S(u) \in \mathcal{B}$ and $\tilde{y} = S(\tilde u) \in \mathcal{B}$ for $\tilde u\in V$. Therefore, the difference $w = \tilde{y} - y$ satisfies the equation
\bean
&\partial_t w +\partial_x w + \partial_{xxx} w - \gamma \partial_{xx} w  + \frac 1 2\partial_x ((y+\tilde y) w)= \tilde u - u \mbox{ in } I\times\Omega,\\
&w\cdot,0) = w(\cdot,L) = \partial_x w(\cdot,L) = 0 \mbox{ in } I,\\
&w(0,x) = 0 \mbox{ in } \Omega,
\eean
in the weak sense of \eqref{weakformkdv}. According to Appendix \ref{appendixtangent} $w \in \mathcal{B}$ satisfies the a priori estimates
\[
\norm{w}_{\mathcal{B}} \leq C(T,L,u,\tilde u)\norm{u-\tilde u}_{\M}.
\]
Thus we can conclude that the solution operator $S$ is locally Lipschitz continuous.
\qquad\end{proof}

\begin{proposition}
  The control to state operator $S\colon \tilde U_{ad}\rightarrow \mathcal B$ is continuously Fr\'echet-differentiable. Its derivative
  \[
  S'(u)\colon \M\rightarrow \mathcal B,~\delta u\mapsto
  \delta y
  \]
  at $u\in U_{ad}$ is given by the solution operator of the linear tangent equation
  \begin{subequations}
   \begin{numcases}{}
      \partial_t \delta y +\partial_x \delta y -\gamma \partial_{xx} \delta y+ \partial_{xxx} \delta y + \partial_x (y \delta y)=\delta u \mbox{ in } I\times\Omega,  \label{linearizedkdv1}\\
      \delta y(\cdot,0) = \delta y(\cdot,L) = \partial_x \delta y (\cdot,L) = 0 \mbox{ on } I,  \label{linearizedkdv2}\\
      \delta y(0,\cdot) = 0 \mbox{ on } \Omega  \label{linearizedkdv3}.
   \end{numcases}
   \label{tan eq}
  \end{subequations}
  \label{propfrechet}
\end{proposition}
%[Proof of Proposition~\ref{propfrechet}]
\begin{proof}
First we mention that $S$ is well-defined on $\tilde U_{ad}$ and that the non-linearity $F:\mathcal B\rightarrow L^2(I,H^{-1}(\Omega)),~y\mapsto y\partial_x y$ is Fr\'echet differentiable since there holds
\[
\|F(y+\delta y)-F(y)-F'(y)\delta y\|_{\Hm1}\leq \frac 1 2\|\delta y\|_{L^4(I\times \Omega)}^2\leq c\,\|\delta y\|_{\mathcal B}^2
\]
with $F'(y)\delta y=\partial_x(y\delta y)$ for any $\delta y\in \mathcal B\hookrightarrow L^4(I\times \Omega)$. Then we differentiate the fixed point equation $y=\mathcal L(u-y\partial_x y,y_0)$ with respect to $(y,u)$ in direction $(\delta y,\delta u)\in \mathcal B\times \M$ and get
\be\label{abstract_tangent_equation}
\delta y=\mathcal L'(\delta u-\partial_x(y\delta y))
\ee
where $\mathcal L'(\cdot)=\mathcal L(\cdot,0)$. In the Appendix~\ref{appendixtangent} it is shown that \eqref{abstract_tangent_equation} has a unique solution $\delta y\in \mathcal B$.  Actually $\delta y$ is the weak solution of \eqref{linearizedkdv1}-\eqref{linearizedkdv3} in the sense of \eqref{weakformkdv}. Next we show that $S'(u)\delta u:=\delta y$ is the Fr\'echet derivative of $S$. This will result from the study of
\[
\frac{1}{\norm{\delta u}_{\M}} \norm{S(u + \delta u) - S(u)  -S'(u)\delta u}_{\mathcal B} = \frac{1}{\norm{\delta u}_{\M}} \norm{\tilde{y} - y  -\delta y}_{\mathcal B}.
\]
Calling $w = \tilde{y} - y - \delta y\in \mathcal B$ the function $w$ then satisfies
\bean
  &\partial_t w +\partial_x w + \partial_{xxx} w - \gamma \partial_{xx} w  + \tilde{y}\partial_x \tilde{y}  - y\partial_x y - \partial_x(y\delta y)=  0 \mbox{ in } I\times\Omega,\nonumber\\
  &w(\cdot,0) = w(\cdot,L) = \partial_x w (\cdot,L) = 0 \mbox{ in } I,\nonumber\\
  &w(0,\cdot) = 0 \mbox{ in } \Omega\nonumber.
\eean
in the weak sense of \eqref{weakformkdv}. After rearranging the terms we end up with
\bean
&\partial_t w +\partial_x w + \partial_{xxx} w - \gamma \partial_{xx} w  + \partial_x(yw) =  -(\tilde{y} - y)\partial_x(\tilde{y} - y) \mbox{ in } I\times\Omega,\\
&w(\cdot,0) = w(\cdot,L) = \partial_x w (\cdot,L) = 0 \mbox{ in } I,\\
&w(0,\cdot) = 0\mbox{ in } \Omega.
\eean
According to Appendix~\ref{appendixtangent} and Lemma \ref{lemyyx2} it holds
\[
{\color{red} \norm{w}_{\mathcal{B}} \leq C(T,L,u)\norm{(\tilde{y} - y)\partial_x(\tilde{y} - y)}_{\Hm1}\leq C(T,L,u)\,T^{1/4}\norm{\tilde{y} - y}_{\mathcal{B}}^2.}
\]
Therefore the conclusion follows from local Lipschitz continuity of $S$, see Lemma \ref{lipschitzcontinuity}. Hence we provide the following lemma which concludes the proof.
\qquad\end{proof}

Therefore the control-to-observation operator $S_{obs}$ is also Fr\'echet differentiable and its derivative is given by
\[S_{obs}'(u)\colon \delta u\mapsto (\chi_{\Omega_o}\delta y,\chi_{\Omega_o}\delta y(T))\]
where $\delta y\in \mathcal B$ is the weak solution of \eqref{tan eq}. Next we introduce the adjoint control to observation operator $S'^\star$.
\begin{proposition}
  Let $u\in U_{ad}$. There exists a bounded linear operator
  \[
  \SO'^\star(u)\colon L^2(I\times\Omega_o)\times L^2(\Omega_o)\rightarrow \C, (\phi,p_T)\mapsto p
  \]
  which fulfills
  \begin{multline}
  (\SO'(u)\delta u,\phi)_{L^2(I\times \Omega_o)}+((\SO'(u)\delta u)(T),p_T)_{L^2(\Omega_o)}\\
  =\langle\delta u, \SO'^\star(u)(\phi,p_T)\rangle_{\M,\C}\\
  \forall \delta u\in\M,~(\phi,p_T) \in L^2(I\times \Omega_o)\times L^2(\Omega_o).
  \label{adjointwf}
  \end{multline}
  Moreover it is the solution operator of
  \begin{subequations}
   \begin{numcases}{}
      -\partial_t p -\partial_x  p -\gamma \partial_{xx} p - \partial_{xxx} p  - y\partial_x p=\phi \mbox{ in } I\times\Omega,\label{adjointKdV1}\\
      p(\cdot,0) = p(\cdot,L) = \partial_x p(\cdot,0) = 0 \mbox{ in } I,\label{adjointKdV2}\\
      p(T,\cdot) = p_T \mbox{ in } \Omega\label{adjointKdV3}
   \end{numcases}
  \end{subequations}
  with $y=S(u)$ for $(\phi,p_T)\in L^2(I\times\Omega_o)\times L^2(\Omega_o)$.
  \label{adjointKdV}
\end{proposition}
%[Proof of Proposition~\ref{adjointKdV}]
\begin{proof}
First of all we mention that $y\partial_x p\in L^1(I,L^2(\Omega))$ holds for $y\in \mathcal B$ and $p\in \mathcal B$, cf., Lemma \ref{lemadjoint}. We use the weak formulation of the tangent equation and get
\begin{multline}
(\SO'(u)\delta u,\phi)_{L^2(I\times \Omega_o)}+((\SO'(u)\delta u)(T),p_T)_{L^2(\Omega_o)}\\
=(\delta y,\chi_{\Omega_o}^\ast\phi)_{L^2(I\times\Omega)}+(\delta y(T),\chi_{\Omega_o}^\ast p_T)_{L^2(\Omega)}-(\delta y,y\partial_x p)_{L^2(I\times\Omega)}\\
=\langle \delta u,p\rangle_{\M,\C}
\label{tangentwf}
\end{multline}
for $\delta u\in \M$ and $y=S(u)\in\mathcal B$ where $\chi_{\Omega_o}^\ast$ is the extension operator to $\Omega$. By comparing with \eqref{adjointwf}, we set $S'^\star(u)(\phi,p_T):=\chi_{\Omega_c}p$ where $p$ solves the fixed point equation
\be\label{fixed_point_equation_adjoint}
p(t)=W^*(T-t)p_T+\int_t^TW^*(s-t)(\phi(s)-y(s)\partial_xp(s))~\mathrm ds,\quad t\in I.
\ee
In Appendix \ref{appendixadjoint} we show that the fixed point equation \eqref{fixed_point_equation_adjoint} has a unique solution $p\in \mathcal B\hookrightarrow\C$ which depends continuously on $(\phi,p_T)$.
\qquad\end{proof}

Next we derive first order optimality conditions using tools from convex analysis.
\begin{proposition}
  Let $(\bar y,\bar u)\in \mathcal B\times U_{ad}$ be a solution of \eqref{cost}. Then $\bar u$ satisfies the following variational variational inequality
  \be
  \langle -\chi_{\Omega_c}\bar p,u-\bar u\rangle_{\C,\M}+\|\bar u\|_{\M}\leq\|u\|_{\M}\quad\forall u\in U_{ad},
  \label{subgradientcond}
  \ee
  where $\bar p$  is the solution of the adjoint state equation
  \bean
  &-\partial_t\bar p -\partial_x \bar p -\gamma \partial_{xx} \bar p -\partial_{xxx} \bar p - \bar y\partial_x \bar p=\chi_{\Omega_o}\bar y-z_1 \mbox{ in } \Omega,\\
  &\bar p(\cdot,0) = \bar p(\cdot,L) = \partial_x \bar p(\cdot,0) = 0 \mbox{ in } I,\\
  &\bar p(T,\cdot) =\chi_{\Omega_o}y(T)-z_2 \mbox{ in } \Omega.
  \eean
\end{proposition}
\begin{proof}
  We define
  \[
  F(u_1,u_2)=\frac 1 2\left(\|y_1-z_1\|_{L^2(I\times \Omega_{o})}^2+\|y_2-z_2\|_{L^2(\Omega_{o})}^2\right)
  \]
  for $(y_1,y_2)\in L^2(I\times \Omega_o)\times L^2(\Omega_o)$ and $\psi(u)=\|u\|_{\M}.$
  Since $F$ and $\SO$ are Fr\'echet differentiable the directional derivative of $F\circ \SO$ at $\bar u$ has the form
  \[
  D(F\circ \SO,\bar u,\delta u) =\langle S_{obs}'^\star(\bar u)(S_{obs}(\bar u)-z),\delta u\rangle_{\C,\M},\quad \delta u\in\C.
  \]
  Then we set $\chi_{\Omega_c}\bar p:=S_{obs}'^\star(\bar u)(S_{obs}(\bar u)-z)$. An element $\bar u\in U_{ad}$ is optimal if and only if
  \[
  F\circ \SO(\bar u)+\psi(\bar u)\leq F\circ \SO(u)+\psi(u)\quad\forall u\in U_{ad}
  \]
  and in  particular
  \[
  F\circ \SO(\bar u)+\psi(\bar u)\leq F\circ \SO(\bar u + \varepsilon(u-\bar u))+\psi(\bar u+ \varepsilon(u-\bar u))
  \]
  for some $0<\varepsilon$ small enough such that $\bar u + \varepsilon(u-\bar u)\in U_{ad}$ holds. Using the convexity of $\psi$ we get
  \[
    \frac{F\circ \SO(\bar u)-F\circ \SO(\bar u + \varepsilon(u-\bar u))}{\varepsilon}+ \psi(\bar u)\leq \psi(u)
  \]
  which implies
  \[
  \langle-\chi_{\Omega_c}\bar p ,u-\bar u\rangle_{\C,\M} + \psi(\bar u)\leq \psi(u)\quad\forall u\in U_{ad}.
  \]
\qquad\end{proof}

The subgradient conditions can be equivalently reformulated in the following form.
\begin{proposition}\label{prop:equivoc}
The subgradient condition \eqref{subgradientcond} is equivalent to
\begin{equation}\label{equivoc}
\alpha \|\bar u\|_{\M}+\phi^{\star}(-\chi_{\Omega_c}\bar p)=\langle -\chi_{\Omega_c}\bar p,\bar u\rangle_{\C,\M},\quad \bar u\in U_{ad}
\end{equation}
with
\[
\phi^{\star}(p)=\sup_{u\in U_{ad}}[\langle u,p\rangle_{\C,\M}-\alpha \|u\|_{\M}]
\]
for $p\in \C$.
\end{proposition}
\begin{proof}
This a well known characterization of the subdifferential of a convex function, cf., \cite{EkelandTemam99}.  However the assertion can be easily derived from the definition of the of $\phi^\star$ and \eqref{subgradientcond}.
\qquad \end{proof}

{\color{red} Next we characterize $\phi^\star.$
\begin{lemma}\label{lem:phistar}
The functional $\phi^{\star}(p)\colon \C\rightarrow \mathbb R$ has the form
\[
\phi^{\star}(p)=
\begin{cases}
c_{ad}\,(\|p\|_{\C}-\alpha)^+&\gamma=0\\
\mathcal I_{\C}(p)&\gamma>0
\end{cases}
\]
where $(\cdot)^+ = \operatorname{max}(0,\cdot)$ and
\[
\mathcal I_{\C}(p)=
\begin{cases}
0&\|p\|_{\C}\leq \alpha\\
\infty&\text{else.}
\end{cases}
\]
\end{lemma}
\begin{proof}
In the case $\gamma>0$ we set $b=\infty$ and $b=c_{ad}$ else. Then we have
\begin{align*}
\phi^{\star}(p)&=\sup_{u\in U_{ad}}[\langle u,p\rangle_{\C,\M}-\alpha \|u\|_{\M}]\\
&=\sup_{\lambda\in [0,b]}\sup_{\|u\|_{\M}=\lambda}[\langle u,p\rangle_{\C,\M}-\alpha\lambda]\\
&=\sup_{\lambda\in [0,b]}\lambda[\|p\|_{\C}-\alpha],
\end{align*}
since \[\lambda\|p\|_{\C}=\sup_{\|u\|_{\M}=\lambda}\langle u,p\rangle_{\C,\M}.\]
Therefore, we have
\[
\phi^\star(p)=
\begin{cases}
0&\|p\|_{\C}\leq \alpha\\
b(\|p\|_{\C}-\alpha)&\text{else.}
\end{cases}
\]
This implies the assertion.
\qquad\end{proof}}

Using Proposition \ref{prop:equivoc} and Lemma \ref{lem:phistar} we can derive the following structural properties of the optimal control.
{\color{red}
\begin{proposition}
Let $\bar u\in U_{ad}$ be an optimal control of \eqref{cost}. Moreover let $|\bar u|\in \mathcal M(\Omega)$ be its total-variation measure and $\bar u'$ its the Radon-Nikodym-derivative. Furthermore let $\bar p$ be the corresponding optimal adjoint state. Then there holds
\begin{enumerate}
\item Non-viscous case $\gamma=0$:
\begin{align}
0&=\left(\|\bar u\|_{\M}-\hat c\right)\bar\lambda,\label{scalarlagrange}\\
\operatorname{supp}|\bar u|&\subseteq \{x\in \Omega\colon \|\chi_{\Omega_c}\bar p\|_{L^2(I)}=\alpha+\bar\lambda\}\label{controlsupp}
\end{align}
with $\bar\lambda =(\|\chi_{\Omega_c}\bar p\|_{\C}-\alpha)^+$. Moreover we have
\be
\bar u'(x)=-\frac{\chi_{\Omega_c}\bar p(x)}{\alpha +\bar\lambda}\quad\text{in}~L^1((\mathring\Omega_c,|\bar u|),L^2(I)).
\label{controlintime}
\ee
\item Viscous case $\gamma>0$:
\begin{align}
\operatorname{supp}|\bar u|&\subseteq \{x\in \Omega\colon \|\chi_{\Omega_c}\bar p\|_{L^2(I)}=\alpha\}\label{supp2}\\
\bar u'(x)&=-\frac{\chi_{\Omega_c}\bar p(x)}{\alpha}\quad\text{in}~L^1((\mathring\Omega_c,|\bar u|),L^2(I))\label{Radon2}
\end{align}
\end{enumerate}
\label{propsubgcondition}
\end{proposition}}
\begin{proof}
{\color{red}First we consider the case $\gamma>0$. A proof of \eqref{supp2} and \eqref{Radon2} is given in \cite{pieper2014}.} Then we discuss the case $\gamma>0$ which involves norm-constraints on the control.
Using $\bar u\in U_{ad}$, $\|\chi_{\Omega_c}\bar p\|_{\C}-\bar\lambda\leq\alpha$ and \eqref{equivoc} we can estimate
\begin{multline}\label{estoc}
\alpha\|\bar u\|_{\M}=\int_{\Omega_c}(\bar u',\chi_{\Omega_c}\bar p)_{L^2(I)}~\mathrm d|\bar u|-\hat c\bar\lambda\\
\leq \int_{\Omega_c}(\bar u',\chi_{\Omega_c}\bar p)_{L^2(I)}~\mathrm d|\bar u|-\bar\lambda\|\bar u\|_{\M}\\
\leq \int_{\Omega_c}\|\bar u'\|_{L^2(I)}\|\chi_{\Omega_c}\bar p\|_{L^2(I)}~\mathrm d|\bar u|-\bar\lambda\|\bar u\|_{\M}\\
\leq\|\bar u\|_{\M}(\|\chi_{\Omega_c}\bar p\|_{\C}-\bar\lambda)\leq \alpha\|\bar u\|_{\M}.
\end{multline}
Thus the last chain of inequalities holds with equality and therefore we have
\[
\int_{\Omega_c}(\bar u',\chi_{\Omega_c}\bar p)_{L^2(I)}-\|\bar u'\|_{L^2(I)}\|\chi_{\Omega_c}\bar p\|_{L^2(I)}~\mathrm d|\bar u|=0
\]
which implies \[\bar u'=-\frac 1{\|\chi_{\Omega_c}\bar p\|_{L^2(I)}}\,\chi_{\Omega_c}\bar p\quad\text{in}~ L^1((\Omega_c,|\bar u|),L^2(I)).\]
Moreover we have
\[
\int_{\Omega_c}\|\chi_{\Omega_c}\bar p\|_{L^2(I)}-\bar\lambda-\alpha~\mathrm d|\bar u|=0
\]
which then implies \eqref{controlsupp} and \eqref{controlintime}. Equality in \eqref{estoc} also implies
\[
(\hat c-\alpha\|\bar u\|_{\M})\bar\lambda=0.
\]
\qquad\end{proof}
{\color{red}
\begin{remark}
If the constraint $\|\bar u\|_{\M}\leq \hat c$ is not active there holds $\bar \lambda=0$ and we recover the usual optimality conditions \eqref{supp2} and \eqref{Radon2}. This can be guaranteed for a large enough parameter $\alpha$, cf. Remark \ref{alphaconstraint}.
\end{remark}}


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "kdv.tex"
%%% End:
